<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout - ElectroCart</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: #f1f3f6; }
    header { background-color: #052860; color: white; padding: 12px 24px; font-size: 22px; font-weight: bold; }
    .container { display: flex; padding: 20px; gap: 20px; flex-wrap: wrap; }
    .left { flex: 1; min-width: 300px; }
    .right-summary { flex: 0 0 300px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: sticky; top: 120px; height: fit-content; }
    .step { background-color: white; border-radius: 4px; margin-bottom: 15px; padding: 16px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    .step h3 { margin: 0 0 10px 0; color: #333; }
    .step-content { display: flex; justify-content: space-between; align-items: center; }
    .change-btn { padding: 5px 12px; background-color: #fff; border: 1px solid #2874f0; color: #2874f0; cursor: pointer; border-radius: 4px; transition: 0.2s ease; }
    .change-btn:hover { background-color: #f0f5ff; }
    .address-form { display: none; margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd; }
    .address-form input, .address-form select { display: block; width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
    .address-form button { background-color: #2874f0; color: white; padding: 10px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
    .address-form button:hover { background-color: #0b5ed7; }
    #continue-btn, .place-order-btn { padding: 10px 20px; background-color: #ff9f00; color: white; border: none; border-radius: 4px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px; }
    #continue-btn:hover, .place-order-btn:hover { background-color: #fb8c00; }
    .payment-box { background-color: white; border-radius: 4px; padding: 16px; box-shadow: 0 0 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
    .payment-options label { display: flex; align-items: center; margin-bottom: 10px; cursor: pointer; }
    .payment-options input { margin-right: 10px; }
    .upi-form { margin-top: 10px; display: flex; gap: 10px; }
    .upi-form input { flex: 1; padding: 6px; border: 1px solid #ccc; }
    .upi-form button { padding: 8px 16px; border: none; cursor: pointer; }
    .upi-form button.gray { background-color: gray; color: white; }
  </style>
</head>
<body>

<header>ElectroCart</header>

<div class="container">

  <!-- LEFT SECTION -->
  <div class="left">

    <!-- LOGIN STEP -->
    <div class="step">
      <h3>1. LOGIN</h3>
      <div class="step-content">
        <p>Email: <span id="user-email"><b>Loading...</b></span></p>
        <div id="change-section" style="display: none; margin-top: 10px;">
          <p style="margin: 0; color: #444;">Log out & Sign in with another account</p>
          <button id="continue-btn">Continue Checkout</button>
        </div>
        <button class="change-btn" id="change-btn">CHANGE</button>
      </div>
    </div>

    <!-- DELIVERY ADDRESS STEP -->
    <div class="step">
      <h3>2. DELIVERY ADDRESS</h3>
      <div class="step-content">
        <p id="delivery-address">Loading...</p>
        <button class="change-btn" id="change-address-btn">CHANGE</button>
      </div>
      <div id="address-form-section" class="address-form">
        <input type="text" id="address" placeholder="Address" required />
        <input type="text" id="city" placeholder="City" required />
        <select id="state" required><option value="">Select State</option></select>
        <input type="text" id="pincode" placeholder="Pincode" required />
        <button id="save-address-btn">Save Address</button>
      </div>
    </div>

    <!-- PAYMENT OPTIONS -->
    <div class="step">
      <h3>3. PAYMENT OPTIONS</h3>
      <div class="payment-box">
        <div class="payment-options">
          <label><input type="radio" name="payment" checked /> UPI</label>
          <div class="upi-form">
            <input type="text" placeholder="Enter UPI ID" />
            <button id="verify-upi-btn">VERIFY</button>
            <button class="gray" id="pay-now-btn">PAY ₹0</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- RIGHT SECTION: PRICE SUMMARY -->
  <div class="right-summary">
    <h3 style="margin-bottom: 15px; font-weight: 500;">PRICE DETAILS</h3>
    <hr />
    <div style="display: flex; justify-content: space-between; margin: 10px 0;">
      <span>Price (<span id="itemCount">0</span> items)</span>
      <span>₹<span id="totalAmount">0</span></span>
    </div>
    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
      <span>Discount</span>
      <span style="color: green;">– ₹0</span>
    </div>
    <hr />
    <div style="display: flex; justify-content: space-between; font-weight: bold; margin: 10px 0;">
      <span>Total Amount</span>
      <span>₹<span id="grandTotal">0</span></span>
    </div>
  </div>

</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDpb1WrouTcU5p1qrm-PyChtVBofp8S6ZI",
    authDomain: "ecommercesite-504d5.firebaseapp.com",
    projectId: "ecommercesite-504d5",
    storageBucket: "ecommercesite-504d5.appspot.com",
    messagingSenderId: "539154564213",
    appId: "1:539154564213:web:82c160284871ed2cfb643c"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const statesList = ["Andhra Pradesh","Arunachal Pradesh","Assam","Bihar","Chhattisgarh","Goa","Gujarat","Haryana","Himachal Pradesh","Jharkhand","Karnataka","Kerala","Madhya Pradesh","Maharashtra","Manipur","Meghalaya","Mizoram","Nagaland","Odisha","Punjab","Rajasthan","Sikkim","Tamil Nadu","Telangana","Tripura","Uttar Pradesh","Uttarakhand","West Bengal","Delhi","Jammu and Kashmir"];

  document.addEventListener("DOMContentLoaded", async () => {
    // Elements
    const emailElement = document.getElementById("user-email");
    const addressElement = document.getElementById("delivery-address");
    const changeAddressBtn = document.getElementById("change-address-btn");
    const addressFormSection = document.getElementById("address-form-section");
    const saveAddressBtn = document.getElementById("save-address-btn");
    const changeLoginBtn = document.getElementById("change-btn");
    const changeSection = document.getElementById("change-section");
    const continueBtn = document.getElementById("continue-btn");
    const stateSelect = document.getElementById("state");
    const itemCountEl = document.getElementById("itemCount");
    const totalAmountEl = document.getElementById("totalAmount");
    const grandTotalEl = document.getElementById("grandTotal");
    const payBtn = document.getElementById("pay-now-btn");
    const upiInput = document.querySelector(".upi-form input");
    const verifyBtn = document.getElementById("verify-upi-btn");

    // Populate state dropdown
    statesList.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s; opt.textContent = s;
      stateSelect.appendChild(opt);
    });

    let currentUser = null;
    let isValidUPI = false;

    // Function to update summary
    function updateCheckoutSummary() {
      const checkoutItemsData = JSON.parse(localStorage.getItem("checkoutItemsData") || "[]");
      if (!checkoutItemsData.length) {
        itemCountEl.innerText = 0;
        totalAmountEl.innerText = 0;
        grandTotalEl.innerText = 0;
        payBtn.innerText = `PAY ₹0`;
        return;
      }
      const totalQty = checkoutItemsData.reduce((sum, item) => sum + item.qty, 0);
      const checkoutTotal = checkoutItemsData.reduce((sum, item) => sum + (item.price * item.qty), 0);
      itemCountEl.innerText = totalQty;
      totalAmountEl.innerText = checkoutTotal;
      grandTotalEl.innerText = checkoutTotal;
      payBtn.innerText = `PAY ₹${checkoutTotal}`;
    }

    // Initial call
    updateCheckoutSummary();

    // Listen for localStorage changes (if cart.html updates in another tab)
    window.addEventListener("storage", (e) => {
      if (e.key === "checkoutItemsData") updateCheckoutSummary();
    });

    // Firebase Auth
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        emailElement.textContent = user.email;
        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          const data = userSnap.data();
          addressElement.textContent = `${data.address}, ${data.city}, ${data.state} - ${data.pincode}`;
        } else {
          addressElement.textContent = "No address found.";
        }
      } else {
        emailElement.textContent = "Not logged in";
        addressElement.textContent = "Not logged in";
      }
    });

    // Address form toggle and save
    changeAddressBtn.addEventListener("click", () => addressFormSection.style.display = "block");
    saveAddressBtn.addEventListener("click", async () => {
      if (!currentUser) return alert("Login first!");
      const address = document.getElementById("address").value;
      const city = document.getElementById("city").value;
      const state = document.getElementById("state").value;
      const pincode = document.getElementById("pincode").value;
      const userRef = doc(db, "users", currentUser.uid);
      try {
        await updateDoc(userRef, { address, city, state, pincode });
        addressElement.textContent = `${address}, ${city}, ${state} - ${pincode}`;
        addressFormSection.style.display = "none";
        alert("Address saved ✅");
      } catch (err) { console.error(err); alert("Error saving address!"); }
    });

    // Login change
    changeLoginBtn.addEventListener("click", () => changeSection.style.display = "block");
    continueBtn.addEventListener("click", () => window.location.href = "signup.html");

    // UPI validation
    verifyBtn.addEventListener("click", () => {
      const upiID = upiInput.value.trim();
      const upiRegex = /^[\w.\-_]{2,}@[a-zA-Z]{2,}$/;
      if (upiRegex.test(upiID)) { isValidUPI = true; payBtn.classList.remove("gray"); alert("UPI ID valid ✅"); }
      else { isValidUPI = false; alert("Invalid UPI ID ❌"); }
    });

    // Pay button
    payBtn.addEventListener("click", () => {
      if (!isValidUPI) return alert("Verify a valid UPI ID first!");
      const checkoutItemsData = JSON.parse(localStorage.getItem("checkoutItemsData") || "[]");
      const checkoutTotal = checkoutItemsData.reduce((sum, item) => sum + (item.price * item.qty), 0);
      const amount = checkoutTotal * 100;
      const options = {
        key: "rzp_test_thujzvuOW95wh5",
        amount: amount,
        currency: "INR",
        name: "ElectroCart",
        description: "Order Payment",
        handler: function(response) {
          alert("Payment successful ✅\nPayment ID: " + response.razorpay_payment_id);
          localStorage.removeItem("buyNowProduct");
          localStorage.removeItem("checkoutItemsData");
          window.location.href = "thankyou.html";
        },
        prefill: { email: currentUser?.email || "", contact: "" },
        theme: { color: "#ff9f00" }
      };
      const rzp = new Razorpay(options);
      rzp.open();
    });

  });
</script>

</body>
</html>
